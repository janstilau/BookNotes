# happyin

## Weixin

[微信支付](https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3)
![weixinPay](images/weixinpay.png)

商户系统和微信支付系统主要交互说明：
步骤1：用户在商户APP中选择商品，提交订单，选择微信支付。
步骤2：商户后台收到用户支付单，调用微信支付统一下单接口。参见【统一下单API】。
步骤3：统一下单接口返回正常的prepay_id，再按签名规范重新生成签名后，将数据传输给APP。参与签名的字段名为appid，partnerid，prepayid，noncestr，timestamp，package。注意：package的值格式为Sign=WXPay
步骤4：商户APP调起微信支付。api参见本章节【app端开发步骤说明】
步骤5：商户后台接收支付通知。api参见【支付结果通知API】
步骤6：商户后台查询支付结果。，api参见【查询订单API】

首先要在app启动的时候, 将微信分配给你的appId注册到微信的api里面.
在appDelegate里面, openUrl里面, 接受微信客户端的信息, 在这里面作为支付后的回调.
调用微信支付的api的时候, 需要的参数都要从后端获取, 后端会和微信的支付系统进行请求处理, 将prepayId, partnerId, 还有时间戳, 签名信息返回回来, 客户端调用wx的支付api的所有信息都要从自己的后端获取, 自己不做签名.

## ZFB

支付宝的流程和微信差不多. 具体细节可能稍微有点不一样.

## 支付订单信息的存储.

在支付之后, happyIn是需要上传照片数据的, 但是, 如果用户不返回到app呢, 这样就会接受不到wx和支付宝的回调. 所以, 要在即将调用wxpay或者zfbpay的时候, 把数据存储起来. 然后, 在app重新成为foreground程序的时候, 进行一个detectionOrderPayState的验证, 向服务器询问一下自己的订单状态, 如果支付成功了, 就进行下面的上传照片的操作. 如果进程杀掉了呢, 所以在启动的时候, 也是要验证一下存储的数据, 如果有的话, 调用detectionOrderPayState进行验证操作. 在验证网络请求的回调里面, 判断返回值, 如果成功了, 就执行后面的操作.

## 苹果内购

苹果内购的流程很简单, 不过最后还是要拿到票据之后, 向服务器进行验证, 在服务器的验证信息里面, 返回用户的数据信息, 以服务器的信息为准, 比如, 购买服务是增加6朵花, 不是在客户端的现有数量上加6, 而是直接用服务器的数据覆盖现在自己的值. 最后苹果的数据要进行缓存, 缓存到偏好设置里面, 在这个缓存的信息里面, 要加上transaction的identifier表明是哪一个交易, 要有这个票据的的base64数据, 要有用户的uid. 在服务器端返回之后, 在把缓存数据清掉. 相应的, 在用户进入到这个界面的时候, 如果有缓存数据, 就会和服务器交互, 避免用户损失.