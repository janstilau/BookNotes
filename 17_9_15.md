# 防御式编程  

## 避免程序遭受非法输入的破坏
* 好的程序
	* 垃圾进,什么都不出
	* 垃圾进,出去出错提示
	* 不允许垃圾进来
* 缺乏安全性的程序
	* 垃圾进,垃圾出
* 三种办法处理进来垃圾
	* 检查所有来源于外部的数据的值.确保在允许的范围之内.
	* 检查子程序的所有输入参数的值.
	* 决定如何处理错误的输入数据.

## 断言
* 断言,是指在开发期间使用的,让程序在运行时候进行自检的代码,断言为真,代表程序运行正常,断言为假,则意味着程序中发现了意料之外的错误.断言对于大型程序或者可靠性要求极高的程序尤其有用,通过断言,程序员可以快速的排查因为修改代码或者别的原因,导致的不匹配的接口假定和错误.  
* 断言可以用于代码的各种假定,澄清各种不希望的情形.断言主要是用在开发和维护阶段,通常只在开发阶段被编译进目标代码.
* 断言(bool,text).当bool为false的时候,打印text的值并退出程序.那么我们自己实现的话,就可以`if(!bool){logError(text);exit(-1);}`   

## 使用断言的建议  
* 用错误处理代码来处理预期发生的状况,用断言来处理绝不应该发生的状况.  
	断言是用来检查永远不该发生的情况,用来检查代码中的bug.  
	错误处理啊代码用来检查不太可能发生的非正常情况,这些在写代码的时候就可以预料的到,并且需要在代码里处理.  
	如果触发了错误处理代码,代表着程序有了错误,这个错误可能是之前的数据错误,程序应该对错误进行处理,例如,返回一个提示.而触发了断言,一般代表着,程序代码的逻辑出现了问题,需要修改源代码.   
	
* 避免把需要执行的程序写到断言里面.  
	ASSERT(performAction()) . 这样写的问题在于,如果没有把断言编译进执行代码,那么应该执行的代码段,就永远不能执行了.应该把运行结果赋值给变量,然后用断言测试变量.  
	
* 对于高健壮性的代码,应该先使用断言在处理错误.  
	程序的开发维护,可能经历了许多的版本,经历了长久的时间.导致,在开发阶段不能完全的清除错误,这个时候,还需要在程序里面加上错误的处理方法.断言,可以在开发阶段尽量的排查错误,但是不能解决所有的问题.但是在发布阶段,也是需要这些处理这样的错误的.所以,对于同样的一个错误,先进行断言,后用错误处理代码处理同一个错误,是很常见的.  
	例如,有一个int值,是需要在一个范围里面的,自然可以断言,但是在发布程序的时候,也有可能传进超过的数据.那么错误处理程序,可以让这个数字归到默认值,或者返回错误提示.
	
* 用断言来注解并且验证前条件和后条件.  
	契约式设计,使用前条件和后条件,每个子程序或者类与程序的其他部分形成了一份契约.
	前条件,是子程序或者类的调用方代码在调用子程序或者实例化对象之前确保为真的属性,前条件是调用方代码对其所调用的代码要承担的义务.
	后条件,是子程序或者类在执行结束之后要确保为真的属性,是子程序或者类  对调用方所承担的责任.
	断言可以用来说明前条件后条件.如果数据是来源于系统外部,那么应该用错误处理代码来检查处理非法的数值,如果是源自内部系统,并且这段程序是基于这些值不会超出合法范围的假设,那么用断言是很合适的.
	
## 错误处理的技术
断言用来处理代码中不应该出现的错误.
错误处理用来处理那些预料中可能发生的错误. 如何解决:  

*  返回中立值. 返回一个没有危害的数值.例如计算返回0,取字符串返回空串,指针操作返回一个空指针.如果输入参数有问题,那么将输入参数重置为默认值.  
*  换用下一个正确数据. 读取数据操作,如果某项数据有问题,就读取下一条返回.  
*  返回和前次相同的数据. 和业务相关,例如读取温度计,上一次的数据可能还有效,因为短时间内的温度变化不大.但是和金融相关的就不能这样做.  
*  用最接近的合法值. 
*  记录在警告日志中. 在上面的操作之后,选择记录.
*  返回一个错误码. 决定让错误处理程序来进行错误处理,本地代码仅仅是将这个错误抛到上层.
	* 设置状态变量的值
	* 用状态值作为函数返回值
	* 运用语言內建的异常处理机制.
* 调用错误处理程序.将所有错误处理集中到一个子程序或者对象中,缺点就是责任过于集中,优点是调试方便.  
* 最稳妥的还是在局部处理错误.就是在错误发生的代码内部进行专门的错误处理.不过这种方法使得整个系统的处理逻辑不统一.
* 关闭程序.  

## 健壮性和正确性  
正确性意味着永远不返回不正确的结果,哪怕不返回结果也比返回不准确的好  
健壮性意味着,要不断尝试措施,使得软件可以持续运转下去,哪怕返回不太准确的结果.  
到底哪一个重要,要看软件的用途.安全相关的正确性重要一些,消费性软件健壮性则重要.  

## 高层次设计对于错误处理的影响  
整个程序应该使用一致的方式来进行处理非法的参数.采用通用的处理错误参数的方法,是架构层次的设计决策,需要在高层次进行确定. 一旦确定了,就要始终如一的执行.如果让高层代码处理错误,底层代码进行报告,那么就要高层真的处理了错误.  
如果函数可以返回错误码,那么一定要去检查这个错误码.即使你认为一定不会出错,也要把错误处理写进去.





















	
	
	
	